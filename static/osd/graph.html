<html>
<head>
	<title>OSD Graph</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link id="root" rel="stylesheet" type="text/css" href="/osd/css/root.css">
	<style>
		html,
		body {
			margin: 0;
			padding: 0
		}

		canvas {
			position: absolute;
			left: 0;
			top: 0; 
			padding: var(--padding);
			border-radius: var(--border-radius);
		}

		#axis {
			background-color: var(--background-color);
			box-shadow: var(--box-shadow);
			border: var(--border-width) var(--border-style) var(--border-color);
		}
	</style>
	<script>

		const maxVolts = 32
		const maxAmps = 6
		const tickLength = 3
		
		function drawLine(ctx, x1, y1, x2, y2, color) {
			ctx.shadowColor = color
			ctx.strokeStyle = color
			ctx.beginPath()
			ctx.moveTo(x1, y1)
			ctx.lineTo(x2, y2)
			ctx.stroke()
			return y2
		}

		function drawAxis(canvas, voltColor, ampColor) {
			const ctx = canvas.getContext("2d")

			ctx.resetTransform()
			ctx.translate(0, canvas.height)
			ctx.scale(1, -1)
			ctx.lineWidth = 2

			const g = ctx.createLinearGradient(0, 0, canvas.width, 0)
			g.addColorStop(0, voltColor)
			g.addColorStop(1, ampColor)
			drawLine(ctx, 0, 1, canvas.width, 1, g)

			drawLine(ctx, tickLength, 0, tickLength, canvas.height, voltColor)
			for (let d = 2 * canvas.height / maxVolts, y = d; y <= canvas.height; y += d) {
				drawLine(ctx, 0, y, tickLength, y, voltColor)
			}
			drawLine(ctx, canvas.width - tickLength, 0, canvas.width - tickLength, canvas.height, ampColor)
			for (let d = canvas.height / maxAmps, y = d; y <= canvas.height; y += d) {
				drawLine(ctx, canvas.width - tickLength, y, canvas.width, y, ampColor)
			}
		}
		
		document.addEventListener("DOMContentLoaded", function (e) {
			const s = getComputedStyle(document.documentElement)
			const source = new EventSource("/es");
		
			let voltColor = s.getPropertyValue("--volt-color").trim()
			let ampColor = s.getPropertyValue("--amp-color").trim()
			let lineWidth = parseInt(s.getPropertyValue("--line-width").trim())
			let blurWidth = parseInt(s.getPropertyValue("--blur-width").trim())

			drawAxis(document.getElementById("axis"), voltColor, ampColor)

			source.addEventListener("psu", function(e) {
				const canvas = document.getElementById("psu")
				const ctx = canvas.getContext("2d")
				ctx.translate(0, canvas.height)
				ctx.scale(1, -1)
	
				function x(t) { return Math.round(t / 50) }
				function y(v, m) { return v * canvas.height / m }
							
				const d = JSON.parse(e.data)
				let dx = x(d.time)
				let x1 = 0
			
				let yv = y(d.volts, maxVolts)
				let ya = y(d.amps, maxAmps)
				this.addEventListener("psu", function(e) {
					const d = JSON.parse(e.data)
					let x2 = x(d.time) - dx
					if (x2 >= canvas.width) {
						const sx = x2 - x1
						const img = ctx.getImageData(sx, 0, canvas.width, canvas.height)
						ctx.putImageData(img, 0, 0)
						x1 -= sx
						dx += sx
						x2 = canvas.width - 1
					}
					ctx.lineWidth = lineWidth
					ctx.shadowBlur = blurWidth
					yv = drawLine(ctx, x1, yv, x2, y(d.volts, maxVolts), voltColor)
					ya = drawLine(ctx, x1, ya, x2, y(d.amps, maxAmps), ampColor)
					x1 = x2
				})
			}, {once: true})
	
			source.addEventListener("reload", function(e) {
				const root = document.getElementById("root")
				const n = root.cloneNode(false)
				n.setAttribute("href", e.data)
				n.addEventListener("load", function(e) {
					voltColor = s.getPropertyValue("--volt-color").trim()
					ampColor = s.getPropertyValue("--amp-color").trim()
					lineWidth = parseInt(s.getPropertyValue("--line-width").trim())
					blurWidth = parseInt(s.getPropertyValue("--blur-width").trim())
					drawAxis(document.getElementById("axis"), voltColor, ampColor)
				}, {once: true})
				root.parentElement.replaceChild(n, root)
			})
		});
	</script>
</head>
<body>
	<canvas id="axis" width="256" height="128"></canvas>
	<canvas id="psu" width="256" height="128"></canvas>
</body>
</html>