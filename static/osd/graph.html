<html>
<head>
	<title>OSD Graph</title>
	<link id="root" rel="stylesheet" type="text/css" href="/osd/css/root.css">
	<style>
		html,
		body {
			margin: 0;
			padding: 0
		}

		canvas {
			position: absolute;
			left: 0;
			top: 0; 
			padding: var(--padding);
			border-radius: var(--border-radius);
		}

		#axis {
			background-color: var(--background-color);
			box-shadow: var(--box-shadow);
			border: var(--border-width) var(--border-style) var(--border-color);
		}
	</style>
	<script>

		const maxVolts = 30
		const maxAmps = 5
		const tickLength = 5
		const lineWidth = 2

		function drawLine(ctx, x1, y1, x2, y2) {
			ctx.beginPath()
			ctx.moveTo(x1, y1)
			ctx.lineTo(x2, y2)
			ctx.stroke()
		}

		function drawAxis(canvas, voltColor, ampColor) {
			const ctx = canvas.getContext("2d")

			ctx.translate(0, canvas.height)
			ctx.scale(1, -1)

			ctx.lineWidth = 2

			const g = ctx.createLinearGradient(0, 0, canvas.width, 0)
			g.addColorStop(0, voltColor)
			g.addColorStop(1, ampColor)
			ctx.strokeStyle = g
			drawLine(ctx, 0, 1, canvas.width, 1)

			ctx.strokeStyle = voltColor
			drawLine(ctx, tickLength, 0, tickLength, canvas.height)
			for (let y = 2 * (canvas.height / maxVolts); y <= canvas.height; y += 2 * (canvas.height / maxVolts)) {
				drawLine(ctx, 0, y, tickLength, y)
			}
			ctx.strokeStyle = ampColor
			drawLine(ctx, canvas.width - tickLength, 0, canvas.width - tickLength, canvas.height)
			for (let y = (canvas.height / maxAmps); y <= canvas.height; y += (canvas.height / maxAmps)) {
				drawLine(ctx, canvas.width - tickLength, y, canvas.width, y)
			}
		}

		function LineChart(canvas, color, yscale) {
			const ctx = canvas.getContext("2d")
			ctx.translate(0, canvas.height)
			ctx.scale(1, -1)

			ctx.lineWidth = lineWidth
			ctx.shadowBlur = ctx.lineWidth * 2
			ctx.strokeStyle = color
			ctx.shadowColor = color
			let x1, y, dx = 0
			return function (e) {
				if (dx == 0) {
					dx = e.timeStamp / 64
				}
				let x2 = e.timeStamp / 64 - dx
				if (x2 > canvas.width) {
					const sx = x2 - x1
					const img = ctx.getImageData(sx, 0, canvas.width, canvas.height)
					ctx.putImageData(img, 0, 0)
					x1 -= sx
					dx += sx
					x2 = canvas.width
				}
				ctx.beginPath()
				ctx.moveTo(x1, y)
				y = parseFloat(e.data) * yscale
				ctx.lineTo(x2, y)
				x1 = x2
				ctx.stroke()
			}
		}

		document.addEventListener("DOMContentLoaded", function (e) {
			const s = getComputedStyle(document.documentElement)
			const voltColor = s.getPropertyValue("--volt-color").trim()
			const ampColor = s.getPropertyValue("--amp-color").trim()
			const source = new EventSource("/es");
			const axis = document.getElementById("axis")

			source.addEventListener("reload", (e) => {
				const r = document.getElementById("root")
				r.href = r.href
			})

			drawAxis(axis, voltColor, ampColor)
			source.addEventListener("volts", LineChart(document.getElementById("volts"), voltColor, axis.height / maxVolts))
			source.addEventListener("amps", LineChart(document.getElementById("amps"), ampColor, axis.height / maxAmps))
		});
	</script>
</head>
<body>
	<canvas id="axis" width="512" height="256"></canvas>
	<canvas id="amps" width="512" height="256"></canvas>
	<canvas id="volts" width="512" height="256"></canvas>
</body>
</html>