<html>
<head>
	<title>OSD Graph</title>
	<link id="root" rel="stylesheet" type="text/css" href="/osd/css/root.css">
	<style>
		html,
		body {
			margin: 0;
			padding: 0
		}

		canvas {
			position: absolute;
			left: 0;
			top: 0; 
			padding: var(--padding);
			border-radius: var(--border-radius);
		}

		#axis {
			background-color: var(--background-color);
			box-shadow: var(--box-shadow);
			border: var(--border-width) var(--border-style) var(--border-color);
		}
	</style>
	<script>

		const maxVolts = 32
		const maxAmps = 8
		const tickLength = 5
		
		function drawLine(ctx, x1, y1, x2, y2, style) {
			ctx.shadowColor = style
			ctx.strokeStyle = style
			ctx.beginPath()
			ctx.moveTo(x1, y1)
			ctx.lineTo(x2, y2)
			ctx.stroke()
			return y2
		}

		function drawAxis(canvas, voltColor, ampColor) {
			const ctx = canvas.getContext("2d")

			ctx.translate(0, canvas.height)
			ctx.scale(1, -1)

			ctx.lineWidth = 2

			const g = ctx.createLinearGradient(0, 0, canvas.width, 0)
			g.addColorStop(0, voltColor)
			g.addColorStop(1, ampColor)
			drawLine(ctx, 0, 1, canvas.width, 1, g)

			drawLine(ctx, tickLength, 0, tickLength, canvas.height, voltColor)
			for (let y = 2 * (canvas.height / maxVolts); y <= canvas.height; y += 2 * (canvas.height / maxVolts)) {
				drawLine(ctx, 0, y, tickLength, y, voltColor)
			}
			drawLine(ctx, canvas.width - tickLength, 0, canvas.width - tickLength, canvas.height, ampColor)
			for (let y = (canvas.height / maxAmps); y <= canvas.height; y += (canvas.height / maxAmps)) {
				drawLine(ctx, canvas.width - tickLength, y, canvas.width, y, ampColor)
			}
		}

		document.addEventListener("DOMContentLoaded", function (e) {
			const s = getComputedStyle(document.documentElement)
			const voltColor = s.getPropertyValue("--volt-color").trim()
			const ampColor = s.getPropertyValue("--amp-color").trim()
			const source = new EventSource("/es");
			const axis = document.getElementById("axis")

			drawAxis(axis, voltColor, ampColor)

			const canvas = document.getElementById("psu")
			const ctx = canvas.getContext("2d")
			ctx.translate(0, canvas.height)
			ctx.scale(1, -1)
			ctx.lineWidth = 2
			ctx.shadowBlur = 6
	
			let x1 = 0, y1 = 0, y2 = 0, dx
			source.addEventListener("psu", (e) => {
				const d = JSON.parse(e.data)

				if (dx === undefined) {
					dx = Math.round(d.time / 32) 
				}
				let x2 = Math.round(d.time / 32) - dx
				if (x2 >= canvas.width) {
					const sx = x2 - x1
					const img = ctx.getImageData(sx, 0, canvas.width, canvas.height)
					ctx.putImageData(img, 0, 0)
					x1 -= sx
					dx += sx
					x2 = canvas.width - 1
				} 
				y1 = drawLine(ctx, x1, y1, x2, d.volts * canvas.height / maxVolts, voltColor)
				y2 = drawLine(ctx, x1, y2, x2, d.amps * canvas.height / maxAmps, ampColor)
				x1 = x2
			})

			source.addEventListener("reload", (e) => {
				const r = document.getElementById("root")
				r.href = r.href
			})
		});
	</script>
</head>
<body>
	<canvas id="axis" width="256" height="128"></canvas>
	<canvas id="psu" width="256" height="128"></canvas>
</body>
</html>